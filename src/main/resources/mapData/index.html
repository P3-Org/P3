<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Leaflet in JavaFX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
    />
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }


        .gw-legend img {
            height: auto;
            display: block;
        }

        .gw-legend img {
            width: 100%;
            height: auto;
            display: block;
            background: white;
            border: 1px solid #666;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
></script>
<script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
<script>
    // The different stormsurge styles, signify increase in sea level in m.
    const stormSurgeMap = {
        0: 'havvandpaaland_0',
        0.1: 'havvandpaaland_0_1',
        0.2: 'havvandpaaland_0_2',
        0.3: 'havvandpaaland_0_3',
        0.4: 'havvandpaaland_0_4',
        0.5: 'havvandpaaland_0_5',
        0.6: 'havvandpaaland_0_6',
        0.7: 'havvandpaaland_0_7',
        0.8: 'havvandpaaland_0_8',
        0.9: 'havvandpaaland_0_9',
        1: 'havvandpaaland_1',
        1.1: 'havvandpaaland_1_1',
        1.2: 'havvandpaaland_1_2',
        1.3: 'havvandpaaland_1_3',
        1.4: 'havvandpaaland_1_4',
        1.5: 'havvandpaaland_1_5',
        1.6: 'havvandpaaland_1_6',
        1.7: 'havvandpaaland_1_7',
        1.8: 'havvandpaaland_1_8',
        1.9: 'havvandpaaland_1_9',
        2: 'havvandpaaland_2',
        2.1: 'havvandpaaland_2_1',
        2.2: 'havvandpaaland_2_2',
        2.3: 'havvandpaaland_2_3',
        2.4: 'havvandpaaland_2_4',
        2.5: 'havvandpaaland_2_5',
        2.6: 'havvandpaaland_2_6',
        2.7: 'havvandpaaland_2_7',
        2.8: 'havvandpaaland_2_8',
        2.9: 'havvandpaaland_2_9',
        3: 'havvandpaaland_3',
        // 3.5: 'havvandpaaland_3_5', not in use atm
        // 4: 'havvandpaaland_4',
        // 4.5: 'havvandpaaland_4_5',
        // 5: 'havvandpaaland_5',
        // 5.5: 'havvandpaaland_5_5',
        // 6: 'havvandpaaland_6'
    };

    // The different cloudBurst styles, signify rainfall given in m. (Object key in mm)
    const cloudBurstMap = {
        0: 'bluespot_ekstremregn_0',
        15: 'bluespot_ekstremregn_0_015',
        30: 'bluespot_ekstremregn_0_030',
        45: 'bluespot_ekstremregn_0_045',
        60: 'bluespot_ekstremregn_0_060',
        75: 'bluespot_ekstremregn_0_075',
        90: 'bluespot_ekstremregn_0_090',
        105: 'bluespot_ekstremregn_0_105',
        120: 'bluespot_ekstremregn_0_120',
        135: 'bluespot_ekstremregn_0_135',
        150: 'bluespot_ekstremregn_0_150'
    };
    // The different groundwater layers, signify year event given in years. (object key in years)
    const groundWaterMap = {
        2: '100m_phreatic_all_T2',
        5: '100m_phreatic_all_T5',
        10: '100m_phreatic_all_T10',
        20: '100m_phreatic_all_T20',
        50: '100m_phreatic_all_T50',
        100: '100m_phreatic_all_T100'
    };
    // Predefine variables for later use.
    let climateOverlay, cadOverlayCentroid, cadOverlayBoundary;

    // Adds a placeholder for the Legend to where it will be located
    const Legend = L.control({ position: 'bottomright' });

    // Variables for getting the satellite map from arcgisonline.com as well as attributions
    var esri_attribution = '© Esri © OpenStreetMap Contributors';
    var esri_url ='https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';

    // Variables for getting the street map from openstreetmap.org as well as attributions
    var OSM_attribution = '@openstreetmap.org'
    var OSM_url = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png'

    // Sets the tile layer for leaflet to use the url from satellite map and sets the zoom levels
    var satelliteMap = L.tileLayer(esri_url, {
        maxZoom: 18,
        attribution: esri_attribution,
        zIndex: 1
    });

    // Sets the tile layer for leaflet to use the url from street map and sets the zoom levels
    var streetMap =  L.tileLayer(OSM_url, {
        maxZoom: 18,
        attribution: OSM_attribution,
        zIndex: 1
    })

    // Creates the map
    var map = L.map('map', {
        center: [57.0488, 9.9217],
        zoom: 17,
        layers: [streetMap, satelliteMap]
    });

    // The map objects that will be added to the map
    var baseMaps = {
        "Satellite": satelliteMap,
        "Streets": streetMap
    };

    // When the window is opened and loaded, add the tilelayers from the API's to the leaflet map.
    document.addEventListener('DOMContentLoaded', () => {
        L.Browser.any3d = false; // Force Leaflet to use 2D transforms.

        // Control layers gives the ability to swap between the map objects satelliteMap and streetMap and display it on the map
        L.control.layers(baseMaps).addTo(map);

        // Variable used for inserting the different overlays from wms.
        climateOverlay;
    });

    // Functions for changing the API calls when moving the slider.
    function cloudBurstStyles(index) {
        climateOverlay.setParams({ styles: cloudBurstMap[index] })
    }

    function stormSurgeStyles(index) {
        climateOverlay.setParams({ styles: stormSurgeMap[index] })
    }

    function groundWaterLayers(index) {
        climateOverlay.setParams({ layers: groundWaterMap[index] })
    }


    // Map pin for property
    const redPinIcon = L.icon({
        iconUrl: '../UI/images/pin.png',
        iconSize:     [35, 35],
        iconAnchor:   [12, 41],
        popupAnchor:  [1, -34],
        shadowSize:   [41, 41]
    });

    // Functions for setting up the API calls when the corresponding button is clicked.
    function setCloudburst() {
        // Cloudburst overlay API.
        climateOverlay = L.tileLayer.wms("http://localhost:8080/wms-dmh-proxy", {
            layers: 'dhm_bluespot_ekstremregn',
            styles: 'bluespot_ekstremregn_0_0',
            format: 'image/png',
            transparent: "TRUE",
            token: '614d970326f8c0bc7f7b666245c117f8',
            attribution: '@dataforsyningen.dk',
            zIndex: 5
        }).addTo(map);
    }

    function setGroundwater() {
        // Groundwater levels overlay API.
        climateOverlay = L.tileLayer.wms('http://localhost:8080/wms-hip-proxy', {
            layers: '100m_phreatic_all_T50',
            format: 'image/png',
            transparent: "TRUE",
            version: '1.3.0',
            service: 'WMS',
            token: '4656e62e1c57f5767255b528fb641642', // Required for access.
            styles: 'default',
            attribution: '@dataforsyningen.dk',
            opacity: '0.345',
            zIndex: 5
        }).addTo(map);

        showLegend("hip_dtg_10m_100m(400-400).png");
    }

    function setStormSurge() {
        // Storm surge seawater levels overlay api
        climateOverlay = L.tileLayer.wms("http://localhost:8080/wms-dmh-proxy", {
            layers: 'dhm_havvandpaaland',
            styles: 'havvandpaaland_0',
            format: 'image/png',
            transparent: "TRUE",
            token: '614d970326f8c0bc7f7b666245c117f8',
            attribution: '@dataforsyningen.dk',
            zIndex: 5
        }).addTo(map);
    }

    function setErosion() {
        climateOverlay = L.esri.dynamicMapLayer({
                url: 'http://localhost:8080/arc_gis-nst',
            layers: [2],
            transparent: true,
            format: 'png32',
            dpi: 96,
            f: "image",
            attribution: '@kyst.dk'
        }).addTo(map);
        showLegend("coastal_legend.png");
    }

    // Function for the cadastral overlay when corresponding button is clicked.
    function setCadastral() {
        cadOverlayCentroid = L.tileLayer.wms("http://localhost:8080/wms-daf-proxy", {
            layers: 'Centroide_Gaeldende',
            styles: 'Roede_centroider',
            format: 'image/png',
            transparent: "TRUE",
            token: '614d970326f8c0bc7f7b666245c117f8',
            attribution: '@dataforsyningen.dk',
            zIndex: 5
        }).addTo(map);

        cadOverlayBoundary = L.tileLayer.wms("http://localhost:8080/wms-daf-proxy", {
            layers: 'MatrikelSkel_Gaeldende',
            styles: 'Roede_skel',
            format: 'image/png',
            transparent: "TRUE",
            token: '614d970326f8c0bc7f7b666245c117f8',
            attribution: '@dataforsyningen.dk',
            zIndex: 5
        }).addTo(map);
    }

    // Removes the climateOverlay if it is turned on.
    function removeClimateLayer() {
        if (climateOverlay) {
            map.removeLayer(climateOverlay)
        }
        hideLegend();
    }

    // Removes the cadastralLayer centroid and boundary if it is turned on.
    function removeCadastralLayer(){
        if (cadOverlayCentroid){map.removeLayer(cadOverlayCentroid)}
        if (cadOverlayBoundary){map.removeLayer(cadOverlayBoundary)}
    }

    let currentLegendImg = null;

    Legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'gw-legend');
        if (currentLegendImg) {
            const img = document.createElement('img');
            img.src = currentLegendImg;
            img.style.width = "100%";
            img.style.height = "auto";
            div.appendChild(img);
        } else {
            // Fallback hvis ingen src er sat
            div.textContent = "No legend available";
        }
        return div;
    };

    // Updates the legend size for the different legends
    function updateLegendSize(width) {
        const legendImg = document.querySelector('.gw-legend img');
        if (!legendImg) return;

        // Make legend scale to 20% of WebView width
        const size = width * 0.20;
        legendImg.style.width = size + "px";
        legendImg.style.height = "auto";
    }

    // Show Legend
    function showLegend(imageUrl) {
        currentLegendImg = imageUrl;

        Legend.addTo(map)
        updateLegendSize(window.innerWidth);  // Apply correct size immediately

    }

    // Remove legend
    function hideLegend() {
        currentLegendImg = null;

        map.removeControl(Legend);
    }

    // Pans to a specific coordinate on the map
    window.panTo = function(coords) {
        map.panTo(coords);
    }

    let propertyMarker = null;

    // Adds a property marker to the correct location defined by the input coordinates
    window.showPropertyMarker = function(coords) {
        if (propertyMarker) {
            map.removeLayer(propertyMarker);
        }
        const lat = parseFloat(coords[0]);
        const lon = parseFloat(coords[1]);
        propertyMarker = L.marker([lat, lon], { icon: redPinIcon }).addTo(map);
    }
</script>
</body>
</html>